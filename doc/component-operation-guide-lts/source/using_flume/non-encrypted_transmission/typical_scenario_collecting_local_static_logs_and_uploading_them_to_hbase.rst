:original_name: mrs_01_1067.html

.. _mrs_01_1067:

Typical Scenario: Collecting Local Static Logs and Uploading Them to HBase
==========================================================================

Scenario
--------

This section describes how to use Flume client to collect static logs from a local computer and upload them to the **flume_test** table of HBase.

.. note::

   By default, the cluster network environment is secure and the SSL authentication is not enabled during the data transmission process. For details about how to use the encryption mode, see :ref:`Configuring the Encrypted Transmission <mrs_01_1069>`. The configuration can apply to scenarios where only the client or the server is configured, for example, Client/Server:Spooldir Source+File Channel+HBase Sink.

Prerequisites
-------------

-  The cluster, HBase, and Flume service have been installed.
-  The Flume client has been installed. For details about how to install the client, see :ref:`Installing the Flume Client on Clusters <mrs_01_1595>`.
-  The network environment of the cluster is secure.
-  An HBase table has been created by running the **create 'flume_test', 'cf'** command.
-  The system administrator has understood service requirements and prepared HBase administrator **flume_hbase**.

Procedure
---------

#. On FusionInsight Manager, choose **System > User** and choose **More > Download Authentication Credential** to download the Kerberos certificate file of user **flume_hbase** and save it to the local host.
#. Configure the client parameters of the Flume role.

   a. Use the Flume configuration tool on FusionInsight Manager to configure the Flume role client parameters and generate a configuration file.

      #. Log in to FusionInsight Manager and choose **Cluster** > *Name of the desired cluster* > **Services** > **Flume** > **Configuration Tool**.

      #. Set **Agent Name** to **client**. Select the source, channel, and sink to be used, drag them to the GUI on the right, and connect them.

         Use SpoolDir Source, File Channel, and Avro Sink, as shown in :ref:`Figure 1 <mrs_01_1067__en-us_topic_0000001219149245_feb76f182aaac42cbbc167cb040e99cc3>`.

         .. _mrs_01_1067__en-us_topic_0000001219149245_feb76f182aaac42cbbc167cb040e99cc3:

         .. figure:: /_static/images/en-us_image_0000001349059729.png
            :alt: **Figure 1** Example for the Flume configuration tool

            **Figure 1** Example for the Flume configuration tool

      #. Double-click the source, channel, and sink. Set corresponding configuration parameters by seeing :ref:`Table 1 <mrs_01_1067__en-us_topic_0000001219149245_t945f3224f8ee46489f0af2556fb132e3>` based on the actual environment.

         .. note::

            -  If the client parameters of the Flume role have been configured, you can obtain the existing client parameter configuration file from *client installation directory*\ **/fusioninsight-flume-1.9.0/conf/properties.properties** to ensure that the configuration is in concordance with the previous. Log in to FusionInsight Manager, choose **Cluster** > *Name of the desired cluster* > **Services** > **Flume** > **Configuration Tool** > **Import**, import the file, and modify the configuration items related to non-encrypted transmission.
            -  It is recommended that the numbers of Sources, Channels, and Sinks do not exceed 40 during configuration file import. Otherwise, the response time may be very long.

      #. Click **Export** to save the **properties.properties** configuration file to the local.

         .. _mrs_01_1067__en-us_topic_0000001219149245_t945f3224f8ee46489f0af2556fb132e3:

         .. table:: **Table 1** Parameters to be modified of the Flume role client

            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+
            | Parameter             | Description                                                                                                                                                                                                                                                                                                                                                                                                                                             | Example Value                              |
            +=======================+=========================================================================================================================================================================================================================================================================================================================================================================================================================================================+============================================+
            | Name                  | The value must be unique and cannot be left blank.                                                                                                                                                                                                                                                                                                                                                                                                      | test                                       |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+
            | spoolDir              | Specifies the directory where the file to be collected resides. This parameter cannot be left blank. The directory needs to exist and have the write, read, and execute permissions on the flume running user.                                                                                                                                                                                                                                          | /srv/BigData/hadoop/data1/zb               |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+
            | trackerDir            | Specifies the path for storing the metadata of files collected by Flume.                                                                                                                                                                                                                                                                                                                                                                                | /srv/BigData/hadoop/data1/tracker          |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+
            | batchSize             | Specifies the number of events that Flume sends in a batch (number of data pieces). A larger value indicates higher performance and lower timeliness.                                                                                                                                                                                                                                                                                                   | 61200                                      |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+
            | dataDirs              | Specifies the directory for storing buffer data. The run directory is used by default. Configuring multiple directories on disks can improve transmission efficiency. Use commas (,) to separate multiple directories. If the directory is inside the cluster, the **/srv/BigData/hadoop/dataX/flume/data** directory can be used. **dataX** ranges from data1 to dataN. If the directory is outside the cluster, it needs to be independently planned. | /srv/BigData/hadoop/data1/flume/data       |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+
            | checkpointDir         | Specifies the directory for storing the checkpoint information, which is under the run directory by default. If the directory is inside the cluster, the **/srv/BigData/hadoop/dataX/flume/checkpoint** directory can be used. **dataX** ranges from data1 to dataN. If the directory is outside the cluster, it needs to be independently planned.                                                                                                     | /srv/BigData/hadoop/data1/flume/checkpoint |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+
            | transactionCapacity   | Specifies the transaction size, that is, the number of events in a transaction that can be processed by the current Channel. The size cannot be smaller than the batchSize of Source. Setting the same size as batchSize is recommended.                                                                                                                                                                                                                | 61200                                      |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+
            | hostname              | Specifies the name or IP address of the host whose data is to be sent. This parameter cannot be left blank. Name or IP address must be configured to be the name or IP address that the Avro source associated with it.                                                                                                                                                                                                                                 | 192.168.108.11                             |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+
            | port                  | Specifies the port that sends the data. This parameter cannot be left blank. It must be consistent with the port that is monitored by the connected Avro Source.                                                                                                                                                                                                                                                                                        | 21154                                      |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+
            | ssl                   | Specifies whether to enable the SSL authentication. (You are advised to enable this function to ensure security.)                                                                                                                                                                                                                                                                                                                                       | false                                      |
            |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                            |
            |                       | Only Sources of the Avro type have this configuration item.                                                                                                                                                                                                                                                                                                                                                                                             |                                            |
            |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                            |
            |                       | -  **true** indicates that the function is enabled.                                                                                                                                                                                                                                                                                                                                                                                                     |                                            |
            |                       | -  **false** indicates that the client authentication function is not enabled.                                                                                                                                                                                                                                                                                                                                                                          |                                            |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+

   b. Upload the **properties.properties** file to **flume/conf/** under the installation directory of the Flume client.

#. Configure the server parameters of the Flume role and upload the configuration file to the cluster.

   a. Use the Flume configuration tool on the FusionInsight Manager portal to configure the server parameters and generate the configuration file.

      #. Log in to FusionInsight Manager and choose **Cluster** > *Name of the desired cluster* > **Services** > **Flume** > **Configuration Tool**.

      #. Set **Agent Name** to **server**. Select the source, channel, and sink to be used, drag them to the GUI on the right, and connect them.

         For example, use Avro Source, File Channel, and HBase Sink, as shown in :ref:`Figure 2 <mrs_01_1067__en-us_topic_0000001219149245_f0496e0941e8448e9b97ce6bcc717406a>`.

         .. _mrs_01_1067__en-us_topic_0000001219149245_f0496e0941e8448e9b97ce6bcc717406a:

         .. figure:: /_static/images/en-us_image_0000001295740072.png
            :alt: **Figure 2** Example for the Flume configuration tool

            **Figure 2** Example for the Flume configuration tool

      #. Double-click the source, channel, and sink. Set corresponding configuration parameters by seeing :ref:`Table 2 <mrs_01_1067__en-us_topic_0000001219149245_t7f360fe0854d4254a5b1ccd6dcd951fe>` based on the actual environment.

         .. note::

            -  If the server parameters of the Flume role have been configured, you can choose **Cluster** > *Name of the desired cluster* > **Services** > **Flume** > **Instance** on FusionInsight Manager. Then select the corresponding Flume role instance and click the **Download** button behind the **flume.config.file** parameter on the **Instance Configurations** page to obtain the existing server parameter configuration file. Choose **Cluster** > *Name of the desired cluster* > **Services** > **Flume** > **Configuration Tool** > **Import**, import the file, and modify the configuration items related to non-encrypted transmission.
            -  It is recommended that the numbers of Sources, Channels, and Sinks do not exceed 40 during configuration file import. Otherwise, the response time may be very long.
            -  A unique checkpoint directory needs to be configured for each File Channel.

      #. Click **Export** to save the **properties.properties** configuration file to the local.

         .. _mrs_01_1067__en-us_topic_0000001219149245_t7f360fe0854d4254a5b1ccd6dcd951fe:

         .. table:: **Table 2** Parameters to be modified of the Flume role server

            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | Parameter             | Description                                                                                                                                                                                                                                                                                                                                                                                                                                             | Example Value                                                                                                                                                                                                                               |
            +=======================+=========================================================================================================================================================================================================================================================================================================================================================================================================================================================+=============================================================================================================================================================================================================================================+
            | Name                  | The value must be unique and cannot be left blank.                                                                                                                                                                                                                                                                                                                                                                                                      | test                                                                                                                                                                                                                                        |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | bind                  | Specifies the IP address to which Avro Source is bound. This parameter cannot be left blank. It must be configured as the IP address that the server configuration file will upload.                                                                                                                                                                                                                                                                    | 192.168.108.11                                                                                                                                                                                                                              |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | port                  | Specifies the ID of the port that the Avro Source monitors. This parameter cannot be left blank. It must be configured as an unused port.                                                                                                                                                                                                                                                                                                               | 21154                                                                                                                                                                                                                                       |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | ssl                   | Specifies whether to enable the SSL authentication. (You are advised to enable this function to ensure security.)                                                                                                                                                                                                                                                                                                                                       | false                                                                                                                                                                                                                                       |
            |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                             |
            |                       | Only Sources of the Avro type have this configuration item.                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                             |
            |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                             |
            |                       | -  **true** indicates that the function is enabled.                                                                                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                                                                                                             |
            |                       | -  **false** indicates that the client authentication function is not enabled.                                                                                                                                                                                                                                                                                                                                                                          |                                                                                                                                                                                                                                             |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | dataDirs              | Specifies the directory for storing buffer data. The run directory is used by default. Configuring multiple directories on disks can improve transmission efficiency. Use commas (,) to separate multiple directories. If the directory is inside the cluster, the **/srv/BigData/hadoop/dataX/flume/data** directory can be used. **dataX** ranges from data1 to dataN. If the directory is outside the cluster, it needs to be independently planned. | /srv/BigData/hadoop/data1/flumeserver/data                                                                                                                                                                                                  |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | checkpointDir         | Specifies the directory for storing the checkpoint information, which is under the run directory by default. If the directory is inside the cluster, the **/srv/BigData/hadoop/dataX/flume/checkpoint** directory can be used. **dataX** ranges from data1 to dataN. If the directory is outside the cluster, it needs to be independently planned.                                                                                                     | /srv/BigData/hadoop/data1/flumeserver/checkpoint                                                                                                                                                                                            |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | transactionCapacity   | Specifies the transaction size, that is, the number of events in a transaction that can be processed by the current Channel. The size cannot be smaller than the batchSize of Source. Setting the same size as batchSize is recommended.                                                                                                                                                                                                                | 61200                                                                                                                                                                                                                                       |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | table                 | Specifies the HBase table name. This parameter cannot be left blank.                                                                                                                                                                                                                                                                                                                                                                                    | flume_test                                                                                                                                                                                                                                  |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | columnFamily          | Specifies the HBase column family name. This parameter cannot be left blank.                                                                                                                                                                                                                                                                                                                                                                            | cf                                                                                                                                                                                                                                          |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | batchSize             | Specifies the maximum number of events written to HBase by Flume in a batch.                                                                                                                                                                                                                                                                                                                                                                            | 61200                                                                                                                                                                                                                                       |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | kerberosPrincipal     | Specifies the Kerberos authentication user, which is mandatory in security versions. This configuration is required only in security clusters.                                                                                                                                                                                                                                                                                                          | flume_hbase                                                                                                                                                                                                                                 |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
            | kerberosKeytab        | Specifies the file path for Kerberos authentication, which is mandatory in security versions. This configuration is required only in security clusters.                                                                                                                                                                                                                                                                                                 | /opt/test/conf/user.keytab                                                                                                                                                                                                                  |
            |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                             |
            |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                         | .. note::                                                                                                                                                                                                                                   |
            |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                                                                                                                                                                                                                                             |
            |                       |                                                                                                                                                                                                                                                                                                                                                                                                                                                         |    Obtain the **user.keytab** file from the Kerberos certificate file of the user **flume_hbase**. In addition, ensure that the user who installs and runs the Flume client has the read and write permissions on the **user.keytab** file. |
            +-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

   b. Log in to FusionInsight Manager and choose **Cluster** > *Name of the desired cluster* > **Services** > **Flume**. On the displayed page, click the **Flume** role on the **Instance** tab page.
   c. Select the Flume role of the node where the configuration file is to be uploaded, choose **Instance Configurations** > **Import** beside the **flume.config.file**, and select the **properties.properties** file.

      .. note::

         -  An independent server configuration file can be uploaded to each Flume instance.
         -  This step is required for updating the configuration file. Modifying the configuration file on the background is an improper operation because the modification will be overwritten after configuration synchronization.

   d. Click **Save**, and then click **OK**.
   e. Click **Finish**.

4. Verify log transmission.

   a. Go to the directory where the HBase client is installed.

      **cd /**\ *Client installation directory*\ **/ HBase/hbase**

      **kinit flume_hbase** (Enter the password.)

   b. Run the **hbase shell** command to access the HBase client.

   c. Run the **scan 'flume_test'** statement. Logs are written in the HBase column family by line.

      .. code-block::

         hbase(main):001:0> scan 'flume_test'
         ROW                                                          COLUMN+CELL
         2017-09-18 16:05:36,394 INFO  [hconnection-0x415a3f6a-shared--pool2-t1] ipc.AbstractRpcClient: RPC Server Kerberos principal name for service=ClientService is hbase/hadoop.<system domain name>@<system domain name>
          default4021ff4a-9339-4151-a4d0-00f20807e76d                 column=cf:pCol, timestamp=1505721909388, value=Welcome to flume
          incRow                                                      column=cf:iCol, timestamp=1505721909461, value=\x00\x00\x00\x00\x00\x00\x00\x01
         2 row(s) in 0.3660 seconds
