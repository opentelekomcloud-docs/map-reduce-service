:original_name: admin_guide_000409.html

.. _admin_guide_000409:

Adding an SQL Inspection
========================

Scenario
--------

You can add rules for specified tenants and SQL engines on FusionInsight Manager. The system will display hints on, intercept, or block SQL requests matched by the rules.

.. note::

   Exercise caution when you add or modify a SQL inspection rule for a cluster, enable a rule, and set the threshold. An improper rule may cause upper-layer service interruption.

Adding a Rule
-------------

#. Log in to FusionInsight Manager as a user with the Manager administrator rights.

#. Click **Cluster** and choose **SQL Inspector**. The **SQL Inspector** page is displayed.

   You can click **View Supported Rules** to view all SQL inspection rules supported by the current cluster.

#. Click **Add Rule**. After the password of the current user is verified, the **Add Rule** page is displayed.

#. Set the required parameters and click **OK**.

   +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | Parameter                         | Description                                                                                                                                                         |
   +===================================+=====================================================================================================================================================================+
   | Name                              | Name of a SQL inspection rule                                                                                                                                       |
   +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | ID                                | Rule ID                                                                                                                                                             |
   |                                   |                                                                                                                                                                     |
   |                                   | For details about meaning of the rules corresponding to the IDs, see :ref:`Table 1 <admin_guide_000409__en-us_topic_0000001662442869_table1960601265610>`.          |
   +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | Tenant                            | Click **Add** to select the name of the tenant to which the current rule will be associated.                                                                        |
   |                                   |                                                                                                                                                                     |
   |                                   | If you need to add a new tenant, plan and create a cluster tenant by referring to :ref:`Tenant Resources <admin_guide_000087>`.                                     |
   +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | Services and Actions              | Click **Add** to specify the SQL engine to which this rule will be associated with and set the threshold parameters of the rule.                                    |
   |                                   |                                                                                                                                                                     |
   |                                   | Each rule can be associated with one SQL engine. If you want to configure a rule for other SQL engines, add new rules.                                              |
   |                                   |                                                                                                                                                                     |
   |                                   | -  **Service**: Select the SQL engine associated with the current rule.                                                                                             |
   |                                   | -  If an SQL request meets the rule, the system performs the following operations:                                                                                  |
   |                                   |                                                                                                                                                                     |
   |                                   |    -  **Hint**: Record logs and display a hint for handling the SQL request. If the rule has parameters, you need to configure the threshold.                       |
   |                                   |    -  **Intercept**: Intercept the SQL request that meets the rule. If the rule has parameters, you need to configure the threshold.                                |
   |                                   |    -  **Block**: Block the SQL request that meets the rule. If the rule has parameters, you need to configure the threshold.                                        |
   |                                   |                                                                                                                                                                     |
   |                                   |       .. note::                                                                                                                                                     |
   |                                   |                                                                                                                                                                     |
   |                                   |          For static and dynamic interception rules, **Hint** and **Block** operations are supported. For blocking rules, only the **Block** operation is supported. |
   +-----------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------+

#. View the added prevention rule on the **SQL Defense** page. The rule takes effect dynamically.

   To adjust the current rule, click **Modify** in the **Operation** column of the row that contains the target rule. After the user password is verified, you can modify rule parameters.


   .. figure:: /_static/images/en-us_image_0000001971077930.png
      :alt: **Figure 1** Viewing SQL inspection rules

      **Figure 1** Viewing SQL inspection rules

.. _admin_guide_000409__en-us_topic_0000001662442869_section19510043143814:

MRS SQL Inspection Rules
------------------------

.. _admin_guide_000409__en-us_topic_0000001662442869_table1960601265610:

.. table:: **Table 1** MRS SQL inspection rules

   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | ID           | Description                                                                                                                           | Engine        | Threshold                                                               | Example SQL Statement                                                              |
   +==============+=======================================================================================================================================+===============+=========================================================================+====================================================================================+
   | static_0001  | Check whether the number of occurrences of count(distinct) in the SQL statement exceeds the limit.                                    | -  Hive       | Number of occurrences of count(distinct)                                | SELECT COUNT(DISTINCT deviceId), COUNT(DISTINCT collDeviceId)                      |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine | Recommended value: **10**                                               | FROM table                                                                         |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | GROUP BY deviceName, collDeviceName, collCurrentVersion;                           |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0002  | Check whether the not in <subquery> statement is used in the SQL statement.                                                           | -  Hive       | N/A                                                                     | SELECT \*                                                                          |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine |                                                                         | FROM Orders o                                                                      |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | WHERE Orders.Order_ID not in (Select Order_ID                                      |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | FROM HeldOrders h                                                                  |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | where h.order_id = o.order_id);                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0003  | Check whether the number of joins in the SQL statement exceeds the limit.                                                             | -  Hive       | Number of joins                                                         | N/A                                                                                |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine | Recommended value: **20**                                               |                                                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0004  | Check whether the number of the **union all** operators in a SQL statement exceeds the threshold.                                     | -  Hive       | Number of the **union all** operators in a statement                    | select \* from tables t1                                                           |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine | Recommended value: **20**                                               | union all select \* from tables t2                                                 |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | union all select \* from tables t3                                                 |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | union all select \* from tables t4                                                 |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | union all select \* from tables t5                                                 |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | union all select \* from tables t6                                                 |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | union all select \* from tables t7                                                 |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | union all select \* from tables t8                                                 |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | union all select \* from tables t9;                                                |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0005  | The number of subquery nesting layers exceeds the limit.                                                                              | -  Hive       | Maximum number of nested subqueries                                     | select \* from (                                                                   |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine | Recommended value: **20**                                               | with temp1 as (select \* from tables)                                              |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               |                                                                         | select \* from temp1);                                                             |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0006  | Check whether the length of the SQL statement string exceeds the upper limit.                                                         | -  Hive       | Length of the SQL string, in KB                                         | N/A                                                                                |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine | Recommended value: **10**                                               |                                                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0007  | Check whether the Cartesian product exists when multiple tables are associated.                                                       | -  Hive       | N/A                                                                     | select \* from A,B;                                                                |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine |                                                                         |                                                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0008  | Check whether alter table update operation is performed at the cluster level (on cluster).                                            | ClickHouse    | N/A                                                                     | alter table testtb1 on cluster default_cluster update price=10.0 where id='100'    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0009  | Check whether alter table delete operation is performed at the cluster level (on cluster).                                            | ClickHouse    | N/A                                                                     | alter table testtb1 on cluster default_cluster delete where id ='10'               |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0010  | Check whether the alter table add column operation is performed at the cluster level (on cluster).                                    | ClickHouse    | N/A                                                                     | alter table testtb1 on cluster default_cluster add column testc String             |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0011  | Check whether the alter table drop column operation is performed at the cluster level (on cluster).                                   | ClickHouse    | N/A                                                                     | alter table testtb1 on cluster default_cluster drop column testc                   |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0012  | Check whether the optimize final operation is performed at the cluster level (on cluster).                                            | ClickHouse    | N/A                                                                     | optimize table testtb1 on cluster default_cluster final                            |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0013  | Check whether the drop table operation is performed at the cluster level (on cluster).                                                | ClickHouse    | N/A                                                                     | drop table testtb1 on cluster default_cluster;                                     |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | static_0014  | Check whether the truncate table operation is performed at the cluster level (on cluster).                                            | ClickHouse    | N/A                                                                     | truncate table testtb1 on cluster default_cluster;                                 |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | dynamic_0001 | Check whether the number of scanned files exceeds the limit.                                                                          | -  Hive       | Number of files that will be scanned or have been scanned               | SELECT ss_ticket_number FROM store_sales WHERE ss_ticket_number=72291252 LIMIT 10; |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine | Recommended value: **100,000**                                          |                                                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | dynamic_0002 | Check whether the number of partitions involved in operations (select, delete, update, and alter) on a table exceeds the upper limit. | -  Hive       | Number of partitions involved in the delete or alter operation          | DELETE FROM table_name WHERE column_name = value                                   |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine | Recommended value: **10,000**                                           |                                                                                    |
   |              |                                                                                                                                       | -  ClickHouse |                                                                         |                                                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | dynamic_0003 | When the right table of a join is a distributed table, check whether the data volume of the right table exceeds the upper limit.      | ClickHouse    | Number of rows in the right table when the join operation is performed. | SELECT name, text FROM table_1 JOIN table_2 ON table_1.Id = table_2.Id             |
   |              |                                                                                                                                       |               |                                                                         |                                                                                    |
   |              |                                                                                                                                       |               | Recommended value: **100,000,000**                                      |                                                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | running_0001 | Check whether the number of result rows returned by the Select statement to the client exceeds the upper limit.                       | -  Hive       | Number of rows in the query result                                      | select \* from table                                                               |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine | Recommended value: **100,000**                                          |                                                                                    |
   |              |                                                                                                                                       | -  ClickHouse |                                                                         |                                                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | running_0002 | Check whether the peak memory usage of the SQL statement exceeds the absolute value limit.                                            | -  Hive       | Memory occupied by SQL running, in MB                                   | N/A                                                                                |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  ClickHouse |                                                                         |                                                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | running_0003 | Check whether the running duration of the SQL statement exceeds the upper limit.                                                      | -  Hive       | SQL running duration threshold, in seconds                              | N/A                                                                                |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  ClickHouse |                                                                         |                                                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
   | running_0004 | The amount of data scanned by the SQL statements.                                                                                     | -  Hive       | Amount of data scanned by the SQL statement, in GB                      | N/A                                                                                |
   |              |                                                                                                                                       | -  Spark      |                                                                         |                                                                                    |
   |              |                                                                                                                                       | -  HetuEngine | Recommended value: **10,240**                                           |                                                                                    |
   |              |                                                                                                                                       | -  ClickHouse |                                                                         |                                                                                    |
   +--------------+---------------------------------------------------------------------------------------------------------------------------------------+---------------+-------------------------------------------------------------------------+------------------------------------------------------------------------------------+
